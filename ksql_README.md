# covid_test_demo
Supplemental files to use when running through a demo/workshop that focuses on Covid testing data


## ksql queries

Create a stream from Applicant data (Oracle)
```sql
CREATE STREAM APPLICANTS WITH (
  KAFKA_TOPIC='ORCLCDB.C__MYUSER.APPLICANTS', 
  VALUE_FORMAT='AVRO'
);
```

Create Stream from CSV Test Data
```sql
CREATE STREAM COUNTY_COVID_S
with (
KAFKA_TOPIC='county-covid',
VALUE_FORMAT='AVRO',
timestamp='Test_Date',
timestamp_format='MM/dd/yyyy'
);
```

Create derived stream from this stream
```sql
CREATE STREAM DERIVED_COVID_S WITH (
  timestamp='TEST_DATE',
  timestamp_format='MM/dd/yyyy',
  KAFKA_TOPIC='derived_covid_s',
  VALUE_FORMAT='AVRO'
) AS
SELECT
PARSE_DATE(TEST_DATE, 'MM/dd/yyyy') AS ISOTESTDATE,
TEST_DATE,
COUNTY,
CAST(NEW_POSITIVES AS DOUBLE) AS NEW_POSITIVES,
CAST(CUMULATIVE_NUMBER_OF_POSITIVES AS DOUBLE) AS CUMULATIVE_NUMBER_OF_POSITIVES,
CAST(TOTAL_NUMBER_OF_TESTS_PERFORMED AS DOUBLE) AS TOTAL_NUMBER_OF_TESTS_PERFORMED,
CAST(CUMULATIVE_NUMBER_OF_TESTS_PERFORMED AS DOUBLE) AS CUMULATIVE_NUMBER_OF_TESTS_PERFORMED
FROM  COUNTY_COVID_S PARTITION BY COUNTY EMIT CHANGES;
```
 
Sanity test for JOIN query: 
 ```sql
SELECT
A.GIVENNAME + ' ' + A.MIDDLEINITIAL + ' ' + A.SURNAME AS FULLNAME,
A.STREETADDRESS, A.CITY, A.ZIPCODE,
S.COUNTY,
A.EMAILADDRESS,
A.BIRTHDAY,
S.ISOTESTDATE,
FROM_UNIXTIME(CAST(A.OP_TS AS BIGINT)) AS APPLICATION_TIME,
S.NEW_POSITIVES/S.TOTAL_NUMBER_OF_TESTS_PERFORMED * 100 AS POSITIVITY_RATE
FROM  DERIVED_COVID_S S JOIN APPLICANTS A WITHIN 3 DAYS ON S.COUNTY = A.COUNTY
WHERE NEW_POSITIVES/TOTAL_NUMBER_OF_TESTS_PERFORMED * 100 > 10.0
EMIT CHANGES;
```

If that query works - create a Stream from it!  This will create a new topic.

```sql
CREATE STREAM PRIORITY_APPLICANTS WITH (KAFKA_TOPIC='priority', VALUE_FORMAT='AVRO') AS
SELECT
A.GIVENNAME + ' ' + A.MIDDLEINITIAL + ' ' + A.SURNAME AS FULLNAME,
A.STREETADDRESS, A.CITY, A.ZIPCODE,
S.COUNTY,
A.EMAILADDRESS,
A.BIRTHDAY,
S.ISOTESTDATE,
FROM_UNIXTIME(CAST(A.OP_TS AS BIGINT)) AS APPLICATION_TIME,
S.NEW_POSITIVES/S.TOTAL_NUMBER_OF_TESTS_PERFORMED * 100 AS POSITIVITY_RATE
FROM  DERIVED_COVID_S S JOIN APPLICANTS A WITHIN 3 DAYS ON S.COUNTY = A.COUNTY
WHERE NEW_POSITIVES/TOTAL_NUMBER_OF_TESTS_PERFORMED * 100 > 10.0
PARTITION BY S.COUNTY
EMIT CHANGES;
```
